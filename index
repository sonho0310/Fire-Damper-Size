<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tính toán Fire Damper (FD)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Smooth transitions */
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 300ms; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex items-center space-x-3 mb-8">
            <div class="bg-red-600 p-3 rounded-lg shadow-lg">
                <!-- Icon Wind -->
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></svg>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-slate-900">Tính toán Fire Damper (FD)</h1>
                <p class="text-slate-500 text-sm">Công cụ tính kích thước van chặn lửa (HTML Standalone Version)</p>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- LEFT COLUMN: Inputs -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex items-center space-x-2 mb-4 text-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                        <h2 class="font-semibold text-lg">Thông số đầu vào</h2>
                    </div>

                    <div class="space-y-4">
                        <!-- Airflow -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Lưu lượng gió (Q)</label>
                            <div class="flex rounded-md shadow-sm">
                                <input type="number" id="inputAirflow" value="500" class="flex-1 block w-full rounded-l-md border-slate-300 focus:border-red-500 focus:ring-red-500 sm:text-sm py-2 px-3 border" placeholder="Nhập lưu lượng...">
                                <select id="inputUnit" class="bg-slate-100 border border-l-0 border-slate-300 rounded-r-md px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-200 focus:outline-none">
                                    <option value="CMH">m³/h</option>
                                    <option value="LPS">L/s</option>
                                </select>
                            </div>
                        </div>

                        <!-- Coefficient (He so) - NEW -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Hệ số (K)</label>
                            <div class="relative rounded-md shadow-sm">
                                <input type="number" id="inputCoefficient" value="1" step="0.1" class="block w-full rounded-md border-slate-300 focus:border-red-500 focus:ring-red-500 sm:text-sm py-2 px-3 border" placeholder="1.0">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-slate-400 text-xs">x Q</span>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">Lưu lượng tính toán = Q * K</p>
                        </div>

                        <!-- Velocity -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1 flex justify-between">
                                <span>Vận tốc qua FD (v)</span>
                                <span class="text-xs text-slate-400">Tiêu chuẩn: 2.5 m/s</span>
                            </label>
                            <div class="relative rounded-md shadow-sm">
                                <input type="number" id="inputVelocity" value="2.5" step="0.1" class="block w-full rounded-md border-slate-300 focus:border-red-500 focus:ring-red-500 sm:text-sm py-2 px-3 border pr-12">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-slate-500 sm:text-sm">m/s</span>
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-slate-100 my-4 pt-4">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Chế độ chọn kích thước</label>
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <button onclick="setMode('width')" id="btnWidth" class="mode-btn px-2 py-2 text-xs font-medium rounded border bg-red-50 border-red-200 text-red-700 transition-colors">Cố định W</button>
                                <button onclick="setMode('height')" id="btnHeight" class="mode-btn px-2 py-2 text-xs font-medium rounded border bg-white border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors">Cố định H</button>
                                <button onclick="setMode('square')" id="btnSquare" class="mode-btn px-2 py-2 text-xs font-medium rounded border bg-white border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors">Vuông</button>
                            </div>

                            <div id="fixedInputContainer">
                                <label id="fixedLabel" class="block text-xs text-slate-500 mb-1">Nhập kích thước cố định (Rộng) (mm)</label>
                                <input type="number" id="inputFixedDim" value="400" step="50" class="block w-full rounded-md border-slate-300 focus:border-red-500 focus:ring-red-500 sm:text-sm py-2 px-3 border">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MIDDLE COLUMN: Results & Visualization -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Main Result Card -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                        <h2 class="font-semibold text-lg text-slate-800 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="8" y2="6"/><line x1="16" y1="6" x2="16" y2="6"/><line x1="12" y1="6" x2="12" y2="6"/><line x1="12" y1="10" x2="12" y2="10"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="8" y1="10" x2="8" y2="10"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="16" y1="18" x2="16" y2="18"/></svg>
                            Kết quả tính toán
                        </h2>
                        <button onclick="saveResult()" class="flex items-center text-sm bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 transition-colors shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            Lưu kết quả
                        </button>
                    </div>

                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                            
                            <!-- Text Results -->
                            <div class="space-y-6">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-slate-50 p-3 rounded-lg">
                                        <p class="text-xs text-slate-500 uppercase font-semibold">Q tính toán (sau K)</p>
                                        <p class="text-xl font-mono font-bold text-slate-700">
                                            <span id="resFlow">0</span> <span class="text-sm font-sans text-slate-500">m³/s</span>
                                        </p>
                                    </div>
                                    <div class="bg-slate-50 p-3 rounded-lg">
                                        <p class="text-xs text-slate-500 uppercase font-semibold">Diện tích yêu cầu</p>
                                        <p class="text-xl font-mono font-bold text-slate-700">
                                            <span id="resArea">0</span> <span class="text-sm font-sans text-slate-500">m²</span>
                                        </p>
                                    </div>
                                </div>

                                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                    <p class="text-sm text-blue-600 font-medium mb-1">Kích thước FD đề xuất (W x H)</p>
                                    <div class="flex items-end space-x-2">
                                        <span class="text-4xl font-bold text-blue-800 tracking-tight">
                                            <span id="resW">0</span> <span class="text-2xl text-blue-400">x</span> <span id="resH">0</span>
                                        </span>
                                        <span class="text-lg text-blue-600 font-medium mb-1.5">mm</span>
                                    </div>
                                    <p class="text-xs text-blue-400 mt-2">Đã làm tròn lên bội số của 50mm</p>
                                </div>

                                <div class="flex items-center text-sm text-slate-500 bg-slate-50 px-3 py-2 rounded">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                                    Vận tốc thực tế: <strong class="ml-1 text-slate-700" id="resActualVel">0</strong> <span class="ml-1">m/s</span>
                                </div>
                            </div>

                            <!-- Visualizer -->
                            <div class="flex flex-col items-center justify-center h-full min-h-[220px] bg-slate-100 rounded-xl relative border border-slate-200 p-4">
                                <div class="absolute top-2 left-2 text-xs text-slate-400 font-mono">Front View</div>
                                
                                <!-- Damper Representation -->
                                <div id="damperVisual" class="relative bg-white border-4 border-slate-400 shadow-sm flex items-center justify-center transition-all duration-500 ease-out" style="width: 100px; height: 100px;">
                                    <!-- Blades Pattern -->
                                    <div class="w-full h-full flex flex-col justify-between py-1 px-0.5 opacity-20">
                                        <div class="w-full h-0.5 bg-black"></div>
                                        <div class="w-full h-0.5 bg-black"></div>
                                        <div class="w-full h-0.5 bg-black"></div>
                                        <div class="w-full h-0.5 bg-black"></div>
                                        <div class="w-full h-0.5 bg-black"></div>
                                    </div>
                                    <!-- Dimensions Labels -->
                                    <div id="labelW" class="absolute -top-6 w-full text-center text-xs font-bold text-slate-600">0</div>
                                    <div id="labelH" class="absolute -left-8 h-full flex items-center text-xs font-bold text-slate-600 -rotate-90">0</div>
                                </div>
                                
                                <div class="mt-8 text-xs text-slate-400 flex items-center">
                                    <div class="w-3 h-3 bg-white border border-slate-400 mr-1"></div> Frame
                                    <div class="w-3 h-3 bg-slate-300 ml-3 mr-1"></div> Blades
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- History Table -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                    <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="font-semibold text-slate-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>
                            Lịch sử tính toán
                        </h3>
                        <button onclick="clearHistory()" class="text-red-500 hover:text-red-700 p-1" title="Xóa lịch sử">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500">
                                <tr>
                                    <th class="px-6 py-3 font-medium">Lưu lượng (K)</th>
                                    <th class="px-6 py-3 font-medium">Vận tốc</th>
                                    <th class="px-6 py-3 font-medium">Diện tích</th>
                                    <th class="px-6 py-3 font-medium text-blue-600">Size (mm)</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody" class="divide-y divide-slate-100">
                                <!-- History items will appear here -->
                            </tbody>
                        </table>
                        <div id="emptyHistory" class="text-center py-6 text-slate-400 italic">Chưa có dữ liệu lưu</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // State
        let constraintMode = 'width'; // 'width', 'height', 'square'
        let currentResults = {};

        // Elements
        const elAirflow = document.getElementById('inputAirflow');
        const elUnit = document.getElementById('inputUnit');
        const elCoefficient = document.getElementById('inputCoefficient');
        const elVelocity = document.getElementById('inputVelocity');
        const elFixedDim = document.getElementById('inputFixedDim');
        const elFixedLabel = document.getElementById('fixedLabel');
        const elFixedContainer = document.getElementById('fixedInputContainer');
        
        // Buttons
        const btnWidth = document.getElementById('btnWidth');
        const btnHeight = document.getElementById('btnHeight');
        const btnSquare = document.getElementById('btnSquare');

        // Results
        const resFlow = document.getElementById('resFlow');
        const resArea = document.getElementById('resArea');
        const resW = document.getElementById('resW');
        const resH = document.getElementById('resH');
        const resActualVel = document.getElementById('resActualVel');
        const visualBox = document.getElementById('damperVisual');
        const labelW = document.getElementById('labelW');
        const labelH = document.getElementById('labelH');

        // History
        const historyBody = document.getElementById('historyBody');
        const emptyHistory = document.getElementById('emptyHistory');

        // Initial Load
        window.addEventListener('load', () => {
            calculate();
            loadHistory();
        });

        // Event Listeners
        [elAirflow, elUnit, elCoefficient, elVelocity, elFixedDim].forEach(el => {
            el.addEventListener('input', calculate);
            el.addEventListener('change', calculate);
        });

        // Mode Switching
        function setMode(mode) {
            constraintMode = mode;
            
            // Update Button Styles
            [btnWidth, btnHeight, btnSquare].forEach(btn => {
                btn.className = "mode-btn px-2 py-2 text-xs font-medium rounded border bg-white border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors";
            });

            const activeClass = "bg-red-50 border-red-200 text-red-700";
            if(mode === 'width') btnWidth.className = `mode-btn px-2 py-2 text-xs font-medium rounded border ${activeClass} transition-colors`;
            if(mode === 'height') btnHeight.className = `mode-btn px-2 py-2 text-xs font-medium rounded border ${activeClass} transition-colors`;
            if(mode === 'square') btnSquare.className = `mode-btn px-2 py-2 text-xs font-medium rounded border ${activeClass} transition-colors`;

            // Update Inputs
            if (mode === 'square') {
                elFixedContainer.style.display = 'none';
            } else {
                elFixedContainer.style.display = 'block';
                elFixedLabel.innerText = `Nhập kích thước cố định (${mode === 'width' ? 'Rộng' : 'Cao'}) (mm)`;
            }

            calculate();
        }

        // Calculation Logic
        function calculate() {
            const airflow = parseFloat(elAirflow.value) || 0;
            const unit = elUnit.value;
            const k = parseFloat(elCoefficient.value) || 1;
            const velocity = parseFloat(elVelocity.value) || 0;
            const fixedDim = parseFloat(elFixedDim.value) || 0;

            if (airflow <= 0 || velocity <= 0) return;

            // 1. Calculate Effective Airflow (Q * K)
            const effectiveAirflow = airflow * k;
            
            // Convert to m3/s
            let flowM3s = 0;
            if (unit === 'CMH') {
                flowM3s = effectiveAirflow / 3600;
            } else {
                flowM3s = effectiveAirflow / 1000;
            }

            // 2. Face Area
            const requiredAreaM2 = flowM3s / velocity;
            const requiredAreaMm2 = requiredAreaM2 * 1000000;

            // 3. Sizing
            let w = 0;
            let h = 0;
            const step = 50;

            const roundUpToStep = (num) => Math.ceil(num / step) * step;

            if (constraintMode === 'square') {
                const side = Math.sqrt(requiredAreaMm2);
                w = roundUpToStep(side);
                h = roundUpToStep(side);
            } else if (constraintMode === 'width' && fixedDim > 0) {
                w = fixedDim;
                h = roundUpToStep(requiredAreaMm2 / w);
                if (h < 100) h = 100;
            } else if (constraintMode === 'height' && fixedDim > 0) {
                h = fixedDim;
                w = roundUpToStep(requiredAreaMm2 / h);
                if (w < 100) w = 100;
            }

            // 4. Actual Velocity
            const actualAreaM2 = (w * h) / 1000000;
            const actualVel = actualAreaM2 > 0 ? (flowM3s / actualAreaM2) : 0;

            // Update DOM
            resFlow.innerText = flowM3s.toFixed(3);
            resArea.innerText = requiredAreaM2.toFixed(4);
            resW.innerText = w;
            resH.innerText = h;
            resActualVel.innerText = actualVel.toFixed(2);
            labelW.innerText = w;
            labelH.innerText = h;

            // Save for History
            currentResults = {
                airflowInput: airflow,
                unit: unit,
                k: k,
                velocity: velocity,
                w: w,
                h: h,
                area: requiredAreaM2.toFixed(4)
            };

            // Update Visualizer
            updateVisualizer(w, h);
        }

        function updateVisualizer(w, h) {
            const maxDim = Math.max(w, h);
            const scale = 200 / maxDim; // Max px size is 200
            
            let dispW = w * scale;
            let dispH = h * scale;

            // Minimum visual size to avoid collapsing
            if (dispW < 20) dispW = 20;
            if (dispH < 20) dispH = 20;

            visualBox.style.width = `${dispW}px`;
            visualBox.style.height = `${dispH}px`;
        }

        // History Management
        function saveResult() {
            if (!currentResults.w) return;

            const item = {
                id: Date.now(),
                ...currentResults
            };

            // Get existing
            let history = JSON.parse(localStorage.getItem('fd_history') || '[]');
            history.unshift(item); // Add to top
            if (history.length > 50) history.pop(); // Limit to 50
            localStorage.setItem('fd_history', JSON.stringify(history));

            renderHistory(history);
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('fd_history') || '[]');
            renderHistory(history);
        }

        function renderHistory(history) {
            if (history.length === 0) {
                emptyHistory.style.display = 'block';
                historyBody.innerHTML = '';
                return;
            }
            emptyHistory.style.display = 'none';
            
            let html = '';
            history.forEach(item => {
                html += `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-3 font-medium text-slate-700">
                        ${item.airflowInput} <span class="text-xs text-slate-400">${item.unit}</span>
                        ${item.k !== 1 ? `<span class="text-xs text-red-500 font-bold ml-1">(x${item.k})</span>` : ''}
                    </td>
                    <td class="px-6 py-3">${item.velocity}</td>
                    <td class="px-6 py-3">${item.area}</td>
                    <td class="px-6 py-3 font-bold text-blue-600">${item.w} x ${item.h}</td>
                </tr>
                `;
            });
            historyBody.innerHTML = html;
        }

        function clearHistory() {
            localStorage.removeItem('fd_history');
            loadHistory();
        }
    </script>
</body>
</html>
